<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ—…éŠéš¨èº«æ‰‹å†Š</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ—…éŠæ‰‹å†Š">
    
    <link rel="apple-touch-icon" sizes="180x180" href="app-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="app-icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="app-icon.png">
    <link rel="manifest" href="manifest.json">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Display:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --theme-brown: #8C7B70;
            --theme-pink: #E09F9F;
            --theme-bg-light: #F8F8F6;
            --text-primary: #4A423D;
            --text-secondary: #88807B;
            --card-bg: #FFFFFF;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
            --radius-card: 12px;
            --bg-luggage: #EFEBE9; --bg-bag: #E3F2FD; --bg-elec: #F5F5F5; --bg-wear: #FCE4EC; --bg-other: #E8F5E9;
            --font-serif: 'Noto Serif Display', serif;
            --font-sans: 'Helvetica Neue', Arial, 'Noto Sans TC', sans-serif;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--theme-bg-light);
            color: var(--text-primary);
            margin: 0; padding: 0; 
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
            padding-top: env(safe-area-inset-top);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch; 
        }

        /* === æ¬Šé™æ§åˆ¶æ¨£å¼ === */
        .admin-only { display: none !important; }
        body.admin-mode .admin-only { display: flex !important; }
        body.admin-mode .fab.admin-only { display: flex !important; }
        
        /* é–é ­æŒ‰éˆ•æ¨£å¼ */
        .admin-lock-btn {
            position: absolute; 
            top: calc(15px + env(safe-area-inset-top)); 
            right: 15px; 
            background: rgba(255,255,255,0.6); backdrop-filter: blur(5px);
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; z-index: 100;
            color: #666; font-size: 0.9rem;
        }
        .admin-lock-btn.unlocked { color: var(--theme-brown); background: #fff; border: 2px solid var(--theme-brown); }

        /* Hero Header */
        .hero-header {
            position: relative; width: 100%; height: 380px; 
            padding: 40px 20px 0 20px; box-sizing: border-box;
            display: flex; flex-direction: column; justify-content: flex-end;
            color: var(--text-primary);
            background-color: #ddd;
            
            /* ä½¿ç”¨ header-bg.jpg */
            background-image: 
                linear-gradient(to bottom, rgba(248, 248, 246, 0.2) 0%, rgba(248, 248, 246, 0.6) 70%, rgba(248, 248, 246, 1) 100%),
                url('header-bg.jpg');
                
            background-size: cover; background-position: center; background-repeat: no-repeat;
            margin-top: calc(-1 * env(safe-area-inset-top));
            padding-top: calc(40px + env(safe-area-inset-top));
        }
        
        /* å¤©æ°£å°å·¥å…·æ¨£å¼ */
        .weather-widget-float {
            position: absolute; 
            top: calc(55px + env(safe-area-inset-top)); 
            right: 20px;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px);
            padding: 8px 15px; border-radius: 16px; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.6);
            min-width: 60px;
        }
        .weather-icon-large { font-size: 1.6rem; color: #FFB300; margin-bottom: 2px; }
        .weather-temp-large { font-family: var(--font-serif); font-size: 1.1rem; font-weight: bold; }
        .weather-desc { font-size: 0.75rem; color: #666; margin-top: 2px; }

        .time-widget-float { 
            position: absolute; 
            top: calc(50px + env(safe-area-inset-top)); 
            left: 20px; 
            text-align: left;
        }
        /* æ™‚é–“é¡¯ç¤ºè¨­å®šï¼š24å°æ™‚åˆ¶ + æ˜ŸæœŸ */
        .time-display { 
            font-family: var(--font-serif); 
            font-size: 3.5rem; 
            font-weight: 700; 
            line-height: 1; 
            text-shadow: 0 2px 20px rgba(255,255,255,0.9); 
            display: flex;
            align-items: baseline;
            gap: 10px;
        }
        /* æ—¥æœŸé¡¯ç¤ºè¨­å®šï¼šYYYY.MM.DD */
        .date-display { 
            font-family: var(--font-serif); 
            font-size: 1.1rem; 
            color: #444; 
            font-weight: bold; 
            margin-left: 4px; 
            letter-spacing: 1px; 
            margin-top: 5px;
        }

        .day-title-large { font-family: var(--font-serif); font-size: 2rem; margin: 0 0 5px 0; font-weight: 700; line-height: 1.2; text-shadow: 0 0 10px rgba(255,255,255,0.8); }
        .location-tag { color: var(--text-secondary); font-size: 1.1rem; margin-bottom: 15px; display: flex; align-items: center; gap: 5px; }
        
        /* Date Scroller & Tabs */
        .date-scroller { display: flex; overflow-x: auto; padding: 10px 20px; gap: 12px; scrollbar-width: none; margin-top: -10px; z-index: 10; position: relative; }
        .date-scroller::-webkit-scrollbar { display: none; }
        .date-card { 
            flex: 0 0 auto; width: 60px; height: 60px; background: #fff; border-radius: 12px; 
            border: 1px solid #eee; color: var(--text-secondary); transition: all 0.3s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: var(--font-serif); box-shadow: 0 2px 5px rgba(0,0,0,0.03); cursor: pointer;
        }
        .date-card.active { background: var(--theme-brown); color: white; border-color: var(--theme-brown); box-shadow: 0 4px 10px rgba(140, 123, 112, 0.4); }
        .date-card-day { font-size: 0.8rem; text-transform: uppercase; }
        .date-card-num { font-size: 1.4rem; font-weight: bold; line-height: 1; }
        .date-card-add { background: #eee; border: 2px dashed #ccc; color: #999; }

        /* List Tabs */
        .list-tab-card { width: auto; padding: 0 20px; font-size: 1rem; font-weight: bold; }

        /* Content Area */
        .content-area-bg {
            background-color: var(--theme-bg-light);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4' viewBox='0 0 4 4'%3E%3Cpath fill='%239C92AC' fill-opacity='0.05' d='M1 3h1v1H1V3zm2-2h1v1H3V1z'%3E%3C/path%3E%3C/svg%3E");
            min-height: 500px; padding: 10px 0;
        }
        
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Packing & Shopping List */
        .pack-category-card { border-radius: 16px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.03); }
        .pack-title { font-weight: bold; margin-bottom: 12px; font-size: 1.1rem; color: #555; display: flex; align-items: center; gap: 8px; }
        .pack-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .pack-item:last-child { border-bottom: none; }
        .pack-item input[type="checkbox"] { width: 22px; height: 22px; margin: 0 12px 0 0; accent-color: var(--theme-brown); cursor: pointer; flex-shrink: 0; }
        .pack-item.checked span { text-decoration: line-through; color: #aaa; }
        .pack-item span { flex: 1; font-size: 1rem; }

        /* Itinerary Cards */
        #itinerary-list { position: relative; padding: 0 20px; }
        #itinerary-list::before { content: ''; position: absolute; left: 58px; top: 20px; bottom: 0; width: 1px; border-left: 2px dashed #DDD; z-index: 0; }
        .timeline-card-wrapper { display: flex; align-items: flex-start; margin-bottom: 25px; position: relative; z-index: 1; }
        .timeline-time { font-family: var(--font-serif); font-size: 1.5rem; font-weight: 700; color: var(--text-primary); width: 60px; flex-shrink: 0; text-align: right; margin-right: 20px; padding-top: 5px; }
        .card.timeline-style {
            flex: 1; background: var(--card-bg); border-radius: var(--radius-card); padding: 15px;
            box-shadow: var(--shadow); border: none; overflow: hidden; position: relative;
        }
        .event-title-large { font-family: var(--font-serif); font-size: 1.3rem; font-weight: 700; margin: 0 0 5px 0; color: var(--text-primary); }
        .event-loc-row { display: flex; align-items: center; gap: 6px; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 8px; }
        .event-note-box { 
            background: #F8F8F6; padding: 10px; border-radius: 8px; 
            color: #666; font-size: 0.9rem; margin-top: 10px;
            white-space: pre-wrap; line-height: 1.5;
        }
        
        .card-actions-bar { display: flex; gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .action-link { color: var(--text-secondary); font-size: 0.9rem; text-decoration: none; display: flex; align-items: center; gap: 5px; cursor: pointer; }

        /* Expense Cards */
        .expense-card {
            background: #fff; border-radius: 16px; padding: 15px; margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;
            border-left: 5px solid var(--theme-brown);
        }
        .expense-card.transfer-type { border-left-color: #2196F3; background: #E3F2FD; }
        .balance-card { text-align: center; background: #FFFBF0; border: 1px solid var(--theme-brown); padding: 15px; border-radius: 12px; margin-bottom: 20px; position: relative; }
        .money { font-weight: bold; font-family: var(--font-serif); }
        
        .settlement-summary { background: #F8F8F6; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: none; }
        .settlement-summary.visible { display: block; }
        .settlement-summary h4 { margin: 0 0 10px 0; font-size: 1rem; color: var(--theme-brown); }
        .summary-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #ddd; }
        
        /* UI Elements */
        .page { display: none; } .page.active { display: block; }
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; 
            display: flex; justify-content: space-around; padding: 10px 0; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 999; 
            height: 60px; box-sizing: content-box; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { flex: 1; text-align: center; color: #CCC; font-size: 0.7rem; cursor: pointer; } 
        .nav-item.active { color: var(--theme-brown); } 
        .nav-item i { font-size: 1.4rem; margin-bottom: 2px; display: block; }
        
        .fab { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); right: 20px; background: var(--theme-brown); color: white; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(140, 123, 112, 0.4); font-size: 1.5rem; cursor: pointer; z-index: 900; }
        
        /* Click Effect Particle */
        .click-particle {
            position: fixed; pointer-events: none; z-index: 9999;
            font-size: 14px; opacity: 0.8; font-family: serif; 
            animation: floatFade 4.5s ease-out forwards;
        }
        @keyframes floatFade {
            0% { transform: translateY(0) scale(1); opacity: 0.8; }
            50% { opacity: 0.6; }
            100% { transform: translateY(-50px) scale(0.8); opacity: 0; }
        }

        /* Modal & Form Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { 
            background: #fff; padding: 15px 20px; border-radius: 20px; 
            width: 85%; max-width: 320px; max-height: 85vh; overflow-y: auto; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.25); 
        }
        
        input, select, textarea { 
            font-family: var(--font-sans); width: 100%; padding: 8px 10px; margin: 5px 0 12px 0; 
            border: 1px solid #eee; border-radius: 8px; background: #FAFAFA; box-sizing: border-box; font-size: 1rem; 
        }
        .btn { background-color: var(--theme-brown); color: #fff; border: none; padding: 10px; border-radius: 10px; font-size: 1rem; cursor: pointer; width: 100%; margin-top: 5px; font-weight: bold; }
        .btn-outline { background: transparent; border: 1px solid var(--theme-brown); color: var(--theme-brown); }
        .btn-blue { background: #2196F3; color: white; }
        .btn-danger { background-color: #ffcccb; color: #d32f2f; }
        
        /* Split Row Compact Styles */
        .split-row-compact { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .split-cb { width: 20px; height: 20px; flex-shrink: 0; margin: 0; accent-color: var(--theme-brown); }
        .split-name { flex: 0 0 70px; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .split-amt { flex: 1; padding: 6px; height: 36px; margin: 0; text-align: right; }

        .split-mode-toggle { display: flex; background: #eee; border-radius: 8px; padding: 3px; margin-bottom: 12px; }
        .split-mode-btn { flex: 1; text-align: center; padding: 6px; border-radius: 6px; cursor: pointer; color: #888; font-size: 0.9rem; }
        .split-mode-btn.active { background: #fff; color: var(--theme-brown); font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* Time Picker */
        .time-picker-group { display: flex; align-items: center; gap: 5px; } 
        input[type="time"] { appearance: none; -webkit-appearance: none; background: #fff; padding: 8px; font-family: var(--font-serif); font-weight: bold; color: var(--text-primary); text-align: center; }

        .sortable-ghost { opacity: 0.5; background: #f9f9f9; transform: scale(0.98); }
        .transfer-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.95rem; }
        .btn-icon { width: 30px; height: 30px; border-radius: 50%; padding:0; display:flex; align-items:center; justify-content:center; border: none; cursor: pointer; background: #eee; color: #666; }
        
        /* Edit Day Button */
        .edit-day-btn { font-size: 1.2rem; color: #aaa; cursor: pointer; margin-left: 10px; }
        .edit-day-btn:hover { color: var(--theme-brown); }
        
        /* Switch Toggle */
        .switch-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 8px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--theme-brown); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Shopping List */
        #shopping-container { margin-top: 20px; }
        .shop-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }

        /* === æ–°å¢æ¨£å¼ï¼šå¤šé‡ä»˜æ¬¾èˆ‡æ™ºæ…§åˆ†å¸³ === */
        .payer-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .payer-name { flex: 0 0 70px; font-size: 0.9rem; }
        .payer-amt { flex: 1; padding: 6px; text-align: right; border: 1px solid #ddd; border-radius: 4px; }

        /* æ™ºæ…§åˆ†å¸³æ¨£å¼ */
        .split-amt.auto-calc { color: #999; font-style: italic; } /* è‡ªå‹•è¨ˆç®—çš„è®Šç°è‰² */
        .split-amt.manual-calc { color: var(--text-primary); font-weight: bold; } /* æ‰‹å‹•è¼¸å…¥çš„è®Šé»‘è‰² */
    </style>
</head>
<body>

    <div id="page-list" class="page">
        <div class="hero-header" style="height: 320px;">
            <div class="time-widget-float">
                <div class="time-display real-time-clock">--:--</div>
                <div class="date-display real-date-display">--</div>
            </div>
            <div class="day-title-large" id="list-page-title">è¡Œææº–å‚™æ¸…å–®</div>
            <div class="location-tag"><i class="fas fa-tasks"></i> Packing & Shopping</div>
        </div>

        <div class="date-scroller">
            <div class="date-card list-tab-card active" onclick="switchListTab('packing', this)">ğŸ§³ è¡Œæ</div>
            <div class="date-card list-tab-card" onclick="switchListTab('shopping', this)">ğŸ›ï¸ è³¼ç‰©</div>
        </div>

        <div class="content-area-bg" style="padding: 20px;">
            <div id="tab-packing" class="tab-content active">
                <div style="text-align:right; margin-bottom:15px;">
                    <button class="btn btn-small btn-outline" onclick="openPackModal()">+ æ–°å¢è¡Œæç‰©å“</button>
                </div>
                <div id="packing-sections"></div>
            </div>

            <div id="tab-shopping" class="tab-content">
                <div style="text-align:right; margin-bottom:15px;">
                    <button class="btn btn-small btn-outline" onclick="openShopModal()">+ è³¼ç‰©é …ç›®</button>
                </div>
                <div id="shopping-list-area"></div>
            </div>
            
            <div style="height: 60px;"></div>
        </div>
    </div>

    <div id="page-itinerary" class="page active">
        <div class="hero-header">
            <div class="admin-lock-btn" onclick="toggleAdminMode()"><i class="fas fa-lock"></i></div>
            <div class="time-widget-float">
                <div class="time-display real-time-clock">--:--</div>
                <div class="date-display real-date-display">--</div>
            </div>
            <div class="weather-widget-float weather-widget">
                <div class="weather-icon-large weather-icon" id="hero-weather-icon"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="weather-temp-large serif-font weather-temp" id="hero-weather-temp">--Â°C</div>
                <div class="weather-desc" id="hero-weather-desc">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="day-title-large">
                <span id="hero-day-title">Day 1</span>
                <i class="fas fa-edit edit-day-btn admin-only" onclick="openDayEditModal()"></i>
            </div>
            <div class="location-tag" id="hero-day-loc"><i class="fas fa-map-marker-alt"></i> Japan</div>
        </div>

        <div class="date-scroller" id="date-list"></div>
        
        <div class="content-area-bg">
            <div id="itinerary-list"></div>
            <div style="height: 60px;"></div>
        </div>
        <div class="fab admin-only" id="fab-itinerary" onclick="openEventModal()"><i class="fas fa-plus"></i></div>
    </div>

    <div id="page-expense" class="page">
        <div class="hero-header">
            <div class="admin-lock-btn" onclick="toggleAdminMode()"><i class="fas fa-lock"></i></div>
            <div class="time-widget-float">
                <div class="time-display real-time-clock">--:--</div>
                <div class="date-display real-date-display">--</div>
            </div>
            <div class="day-title-large">æˆ‘çš„è¨˜å¸³</div>
            <div class="location-tag"><i class="fas fa-coins"></i> Trip Expenses</div>
        </div>

        <div class="content-area-bg" style="padding:20px;">
            <div class="balance-card">
                <div class="admin-only" style="position: absolute; top:15px; right:15px; cursor:pointer; color:var(--text-secondary);" onclick="openMembersModal()"><i class="fas fa-cog"></i> æˆå“¡</div>
                <h3>ç›®å‰ç´¯è¨ˆæ”¯å‡º (å…¨é«”)</h3>
                <div id="total-expense-display" style="font-size:1.1rem; line-height:1.5; color:#555; font-weight:bold; font-family:var(--font-serif);"></div>
                <button class="btn btn-small btn-outline" style="margin-top:10px;" onclick="renderSettlement()">æŸ¥çœ‹çµç®—</button>
            </div>
            <div id="expense-list"></div>
            <div style="height: 60px;"></div>
        </div>
        <div class="fab admin-only" onclick="openExpenseModal()"><i class="fas fa-yen-sign"></i></div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="switchPage('list', this)"><i class="fas fa-clipboard-list"></i> æ¸…å–®</div>
        <div class="nav-item active" onclick="switchPage('itinerary', this)"><i class="fas fa-calendar-alt"></i> è¡Œç¨‹</div>
        <div class="nav-item" onclick="switchPage('expense', this)"><i class="fas fa-calculator"></i> è¨˜å¸³</div>
    </div>

    <div id="modal-event" class="modal">
        <div class="modal-content">
            <h3 id="evt-modal-title" class="serif-font" style="margin-top:0">è¡Œç¨‹è©³ç´°</h3>
            <label>åˆ†é¡</label><select id="evt-cat" onchange="toggleEventFields()"><option value="spot">â›©ï¸ æ™¯é»</option><option value="transport">ğŸš… äº¤é€š</option><option value="flight">âœˆï¸ èˆªç­</option><option value="food">ğŸœ ç¾é£Ÿ</option><option value="shop">ğŸ›ï¸ è³¼ç‰©</option><option value="other">ğŸ“ å…¶ä»–</option></select>
            <label>è¡Œç¨‹åç¨±</label><input type="text" id="evt-title" placeholder="ä¾‹å¦‚ï¼šåƒè§€æ¸…æ°´å¯º">
            <div id="field-normal">
                <label>æ™‚é–“</label><div class="time-picker-group"><input type="time" id="evt-time"></div>
                <label>åœ°é»</label><input type="text" id="evt-loc">
            </div>
            <div id="field-transport" style="display:none;background:#F0F4F4;padding:10px;border-radius:8px;margin-bottom:15px;">
                <label>æ™‚é–“</label><div class="time-picker-group"><input type="time" id="evt-trans"></div>
                <label>å‡ºç™¼åœ°</label><input type="text" id="evt-trans-from"><label>ç›®çš„åœ°</label><input type="text" id="evt-trans-to">
            </div>
            <div id="field-flight" style="display:none;background:#F2F6F9;padding:10px;border-radius:8px;margin-bottom:15px;">
                <div style="display:flex;gap:10px"><input id="evt-dep-apt" placeholder="å‡ºç™¼"><input id="evt-arr-apt" placeholder="æŠµé”"></div>
                <div style="display:flex;gap:10px">
                    <div style="flex:1">èµ·é£<div class="time-picker-group"><input type="time" id="evt-dep"></div></div>
                    <div style="flex:1">æŠµé”<div class="time-picker-group"><input type="time" id="evt-arr"></div></div>
                </div>
                <div style="display:flex;gap:10px"><input id="evt-flt-no" placeholder="èˆªç­è™Ÿ"><input id="evt-plane" placeholder="æ©Ÿå‹"></div>
            </div>
            <label>å‚™è¨»</label><textarea id="evt-note" rows="3" placeholder="å‚™è¨»..."></textarea>
            <button class="btn" onclick="saveEvent()">å„²å­˜</button><button class="btn btn-outline" style="margin-top:5px" onclick="closeModal('modal-event')">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div id="modal-expense" class="modal">
        <div class="modal-content">
            <h3 id="exp-modal-title" class="serif-font" style="margin-top:0">è¨˜ä¸€ç­†</h3>
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>æ—¥æœŸ</label><input type="date" id="exp-date"></div>
                <div style="flex:1">
                    <label>å¹£åˆ¥</label>
                    <select id="exp-currency" onchange="updateCurrencyUI()">
                        <option value="TWD">TWD (å°å¹£)</option>
                        <option value="JPY">JPY (æ—¥å¹£)</option>
                        <option value="KRW">KRW (éŸ“å…ƒ)</option>
                    </select>
                </div>
            </div>
            
            <label>é …ç›®</label><input type="text" id="exp-title">
            
            <label>ç¸½é‡‘é¡</label>
            <input type="number" id="exp-amount" placeholder="0" oninput="distributePayerAmount()" style="font-family:var(--font-serif); font-weight:bold; font-size:1.2rem; background:#FFFBF0; border:1px solid #8C7B70;">

            <div style="margin:10px 0 5px 0; font-weight:bold; font-size:0.9rem; display:flex; justify-content:space-between;">
                <span>èª°å…ˆä»˜éŒ¢?</span>
                <span id="payer-total-check" style="font-size:0.8rem; color:#888;"></span>
            </div>
            <div id="payer-list-container" style="max-height:150px; overflow-y:auto; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                </div>

            <div style="margin:8px 0 5px 0; font-weight:bold; font-size:0.9rem;">åˆ†å¸³ (<span class="currency-label">JPY</span>)</div>
            <div class="split-mode-toggle">
                <div class="split-mode-btn active" id="mode-avg" onclick="setSplitMode('avg')">å¹³å‡</div>
                <div class="split-mode-btn" id="mode-custom" onclick="setSplitMode('custom')">æ‰‹å‹•/æ™ºæ…§</div>
            </div>
            
            <div id="split-list-container" style="max-height:150px; overflow-y:auto; border-top:1px solid #eee; padding-top:5px;">
                </div>
            
            <div id="split-total-check" style="text-align:right; font-size:0.8rem; color:#888; margin-top:5px;"></div>
            
            <label style="margin-top:10px; display:block;">å‚™è¨»</label><textarea id="exp-note" rows="1"></textarea>
            
            <button class="btn" onclick="saveExpense()">å„²å­˜</button>
            <button class="btn btn-outline" style="margin-top:5px" onclick="closeModal('modal-expense')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="modal-settlement" class="modal">
        <div class="modal-content">
            <h3 class="serif-font">çµç®—å ±å‘Š</h3>
            
            <div class="admin-only" style="background:#f0f0f0; padding:15px; border-radius:8px; margin-bottom:15px;">
                <div class="switch-container" style="margin:0; padding:0; background:transparent; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.9rem;">ğŸ”“ é–‹æ”¾æˆå“¡æŸ¥çœ‹ç¸½è¡¨</span>
                    <label class="switch">
                        <input type="checkbox" id="public-view-toggle" onchange="togglePublicView()">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <hr style="border:0; border-top:1px dashed #ccc; margin:10px 0;">
                
                <div style="display:flex; flex-direction:column; gap:5px;">
                    <span style="font-size:0.9rem; color:#666;">é è¨­è¨˜å¸³å¹£åˆ¥ï¼š</span>
                    <select id="default-currency-select" style="width:100%; margin:0; padding:8px; background:#fff;" onchange="saveDefaultCurrency()">
                        <option value="TWD">å°å¹£ (TWD)</option>
                        <option value="JPY">æ—¥å¹£ (JPY)</option>
                        <option value="KRW">éŸ“å…ƒ (KRW)</option>
                    </select>
                </div>
            </div>
            
            <div id="settlement-rate-info" style="font-size:0.8rem;color:#888;text-align:right;margin-bottom:10px;"></div>
            <div id="settlement-content"></div>
            
            <button class="btn btn-blue admin-only" onclick="openTransferModal()">ğŸ’¸ æ–°å¢è½‰å¸³ç´€éŒ„</button>
            <button class="btn" style="margin-top:5px;" onclick="closeModal('modal-settlement')">é—œé–‰</button>
        </div>
    </div>

    <div id="modal-transfer" class="modal">
        <div class="modal-content">
            <h3 id="trans-modal-title" class="serif-font" style="margin-top:0">æ–°å¢è½‰å¸³ (é‚„æ¬¾)</h3>
            <div style="background:#E3F2FD; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.9rem; color:#0D47A1;">
                ğŸ’¡ ç´€éŒ„è½‰å¸³å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•æ›´æ–°çµç®—é‡‘é¡ã€‚
            </div>
            <label>æ—¥æœŸ</label><input type="date" id="trans-date">
            <label>å¹£åˆ¥</label>
            <select id="trans-currency">
                <option value="TWD">TWD</option>
                <option value="JPY">JPY</option>
                <option value="KRW">KRW</option>
            </select>
            
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <div style="flex:1"><label>èª°</label><select id="trans-from"></select></div>
                <div style="padding-top:15px;"><i class="fas fa-arrow-right"></i></div>
                <div style="flex:1"><label>è½‰çµ¦èª°</label><select id="trans-to"></select></div>
            </div>
            <label>é‡‘é¡</label><input type="number" id="trans-amount" placeholder="0" style="font-weight:bold; font-size:1.2rem;">
            
            <button class="btn btn-blue" onclick="saveTransfer()">ç¢ºèª</button>
            <button class="btn btn-outline" style="margin-top:5px" onclick="closeModal('modal-transfer')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="modal-members" class="modal"><div class="modal-content"><h3 class="serif-font">æˆå“¡</h3><div id="members-list-edit"></div><button class="btn btn-small" onclick="addNewMemberField()">+1</button><hr><button class="btn" onclick="saveMembers()">å„²å­˜</button><button class="btn btn-outline" style="margin-top:5px" onclick="closeModal('modal-members')">å–æ¶ˆ</button></div></div>
    
    <div id="modal-pack-add" class="modal"><div class="modal-content"><h3 class="serif-font">æ–°å¢ç‰©å“</h3><select id="pack-add-cat"><option value="luggage">ğŸ§³ è¡Œæ</option><option value="bag">ğŸ‘œ éš¨èº«</option><option value="elec">ğŸ”Œ é›»å™¨</option><option value="wear">ğŸ‘— è¡£ç‰©</option><option value="other">ğŸ’Š å…¶ä»–</option></select><input type="text" id="pack-add-name"><button class="btn" onclick="saveNewPackItem()">åŠ å…¥</button><button class="btn btn-outline" onclick="closeModal('modal-pack-add')">å–æ¶ˆ</button></div></div>

    <div id="modal-day-edit" class="modal">
        <div class="modal-content">
            <h3 class="serif-font" style="margin-top:0">ç·¨è¼¯å¤©æ•¸è³‡è¨Š</h3>
            <label>æ¨™é¡Œ</label><input type="text" id="day-edit-title">
            <label>åœ°é» (å½±éŸ¿å¤©æ°£)</label><input type="text" id="day-edit-loc">
            <label>æ—¥æœŸ</label><input type="date" id="day-edit-date">
            <button class="btn" onclick="saveDayInfo()">å„²å­˜</button>
            <button class="btn btn-danger" style="margin-top:5px" onclick="deleteDay()">åˆªé™¤é€™å¤©</button>
            <button class="btn btn-outline" style="margin-top:5px" onclick="closeModal('modal-day-edit')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="modal-shop-add" class="modal">
        <div class="modal-content">
            <h3 class="serif-font" style="margin-top:0">æ–°å¢è³¼ç‰©</h3>
            <label>é …ç›®</label>
            <select id="shop-add-cat" onchange="checkShopCat()"></select>
            <input type="text" id="shop-add-new-cat" placeholder="è¼¸å…¥æ–°é …ç›®åç¨±" style="display:none; margin-top:5px;">
            <label>ç‰©å“</label><input type="text" id="shop-add-item">
            <button class="btn" onclick="saveShopItem()">åŠ å…¥</button>
            <button class="btn btn-outline" style="margin-top:5px" onclick="closeModal('modal-shop-add')">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // === Global Variables ===
        const ADMIN_PASSWORD = "8888";
        
        // âš ï¸âš ï¸âš ï¸ é€™æ˜¯æ‚¨æä¾›çš„ç¶²å€ï¼Œè«‹ç¢ºèªæ‚¨å·²å°‡å…¶æ¬Šé™è¨­ç‚ºã€Œä»»ä½•äººã€ âš ï¸âš ï¸âš ï¸
        const API_URL = "https://script.google.com/macros/s/AKfycbzR9dFuhvffKZCDNTo47XVq8F67QLz4I1A_fWje1FNNiNYZG-bg_spN2-EpXgnpUZBmpQ/exec"; 
        
        let isAdminMode = false;
        let editingEvent = {dayIdx:null,evtIdx:null}; 
        let editingExpenseId=null; 
        let editingTransferId=null; 
        let splitMode='avg'; 
        let sortableInstance=null, expSortable=null, shopSortable=null;
        
        let rates = { TWD: 1, JPY: 0.22, KRW: 0.024 }; 
        let currentDayIndex = 0; 

        // åº§æ¨™è³‡æ–™åº« (å½±éŸ¿å¤©æ°£)
        const LOC_COORDS = { 
            'Kyoto': { lat: 35.0116, lon: 135.7681 }, 
            'Osaka': { lat: 34.6937, lon: 135.5023 } 
        };

        // é è¨­è³‡æ–™
        let data = JSON.parse(localStorage.getItem('trip_data_public')) || {
            days: [
                { date: "2026-01-14", title: "Day 1 é›†åˆ", location: "Kyoto", events: [] },
                { date: "2026-01-15", title: "Day 2", location: "Kyoto", events: [] },
                { date: "2026-01-16", title: "Day 3", location: "Osaka", events: [] },
                { date: "2026-01-17", title: "Day 4", location: "Osaka", events: [] },
                { date: "2026-01-18", title: "Day 5 è¿”ç¨‹", location: "Osaka", events: [] }
            ],
            expenses: [], 
            members: ["åœ˜å“¡A", "åœ˜å“¡B", "åœ˜å“¡C", "åœ˜å“¡D", "åœ˜å“¡E", "åœ˜å“¡F"],
            settings: { showTotalsToPublic: false, defaultCurrency: 'JPY' }
        };

        // Private Data
        let myPacking = JSON.parse(localStorage.getItem('my_private_data')) || {
            luggage: [{t:"è¡Œæè¢‹(å¯æŠ˜ç–Š)",c:false}, {t:"è¡£æœæ”¶ç´å£“ç¸®è¢‹",c:false}, {t:"ç’°ä¿è³¼ç‰©è¢‹",c:false}, {t:"è¡Œæé›»å­ç§¤",c:false}],
            bag: [{t:"æ©Ÿç¥¨(é›»å­æ©Ÿç¥¨)",c:false}, {t:"è­·ç…§",c:false}, {t:"éŒ¢åŒ…",c:false}, {t:"ç¾é‡‘&é›¶éŒ¢",c:false}, {t:"ä¿¡ç”¨å¡",c:false}, {t:"ææ¬¾å¡",c:false}, {t:"è­‰åˆ¸æ†‘è­‰",c:false}, {t:"2å‹å¤§é ­è²¼&é§•ç…§æ­£æœ¬",c:false}, {t:"é‘°åŒ™",c:false}, {t:"é›¨å‚˜",c:false}, {t:"è¡›ç”Ÿç´™&æ¿•ç´™å·¾",c:false}, {t:"ç·Šæ€¥è¯çµ¡è³‡æ–™&ç—…æ­·è¡¨",c:false}, {t:"æ°´å£º",c:false}, {t:"è³¼ç‰©è¢‹",c:false}],
            elec: [{t:"æ‰‹æ©Ÿ",c:false}, {t:"è®Šå£“å™¨",c:false}, {t:"å……é›»ç·š",c:false}, {t:"è¡Œå‹•é›»æº",c:false}, {t:"è€³æ©Ÿ",c:false}, {t:"ç›¸æ©Ÿ",c:false}],
            wear: [{t:"è¡£æœ&è¤²å­",c:false}, {t:"å…§è¡£è¤²",c:false}, {t:"è¥ªå­",c:false}, {t:"ç¡è¡£",c:false}, {t:"å¤–å¥—&å¸½å­",c:false}, {t:"é«®åœˆ",c:false}, {t:"é»ƒé‡‘é£¾å“æ‹†é™¤",c:false}],
            other: [{t:"SIMå¡",c:false}, {t:"é˜²æ›¬",c:false}, {t:"å£ç½©",c:false}, {t:"æšˆè»Šè—¥",c:false}, {t:"èª¿ç¶“è—¥",c:false}],
            shopping: [ {name: "ä¼´æ‰‹ç¦®", items: []} ] 
        };

        const CAT_CONFIG = { 'spot': { color: '#E09F9F', name: 'æ™¯é»' }, 'transport': { color: '#94C0C0', name: 'äº¤é€š' }, 'flight': { color: '#A0C4E3', name: 'èˆªç­' }, 'food': { color: '#E3D081', name: 'ç¾é£Ÿ' }, 'shop': { color: '#DDBea9', name: 'è³¼ç‰©' }, 'other': { color: '#B0B0B0', name: 'å…¶ä»–' } };
        const PACK_UI = { 'luggage': { name: 'ğŸ§³ è¡Œæ', bg: 'var(--bg-luggage)' }, 'bag': { name: 'ğŸ‘œ éš¨èº«åŒ…åŒ…', bg: 'var(--bg-bag)' }, 'elec': { name: 'ğŸ”Œ é›»å™¨åƒé£¯', bg: 'var(--bg-elec)' }, 'wear': { name: 'ğŸ‘— è¡£ç‰©', bg: 'var(--bg-wear)' }, 'other': { name: 'ğŸ’Š å…¶ä»–', bg: 'var(--bg-other)' } };
        const SHOP_COLORS = ['#E09F9F', '#94C0C0', '#E3D081', '#DDBea9', '#A0C4E3'];

        // === Main Functions ===

        window.onload = function() {
            startRealTimeClock();
            fetchExchangeRate();
            fetchWeather(); // å•Ÿå‹•å¤©æ°£æŠ“å–
            document.addEventListener('click', createClickEffect);
            renderDates(); 
            renderItinerary(); 
            renderExpenseList(); 
            renderTotalOverview();
            renderPackingList();
            renderShoppingList();
            loadCloudData();
        };

        // Time & Display Utils
        function startRealTimeClock() {
            setInterval(() => {
                const now = new Date();
                
                // 24å°æ™‚åˆ¶æ™‚é–“ (HH:MM)
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const timeStr = `${hours}:${minutes}`;
                
                // æ˜ŸæœŸ (ä¾‹å¦‚ Thu)
                const dayStr = now.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
                
                // æ—¥æœŸæ ¼å¼ YYYY.MM.DD
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const date = String(now.getDate()).padStart(2, '0');
                const fullDateStr = `${year}.${month}.${date}`;
                
                document.querySelectorAll('.real-time-clock').forEach(el => 
                    el.innerHTML = `${timeStr} <span style="font-size:0.4em; margin-left:5px; vertical-align:middle; opacity:0.8;">${dayStr}</span>`);
                
                document.querySelectorAll('.real-date-display').forEach(el => 
                    el.innerText = fullDateStr);
            }, 1000);
        }
        
        // === å¤©æ°£åŠŸèƒ½ (ä½¿ç”¨ Open-Meteo å…è²» API) ===
        async function fetchWeather() {
            const d = data.days[currentDayIndex];
            const locName = d.location; // "Kyoto" or "Osaka"
            
            // é è¨­æŠ“å¤§é˜ªï¼Œå¦‚æœè©²åœ°é»æœ‰å®šç¾©å°±æŠ“è©²åœ°é»
            const coords = LOC_COORDS[locName] || LOC_COORDS['Osaka'];
            
            document.getElementById('hero-weather-desc').innerText = "æ›´æ–°ä¸­...";
            
            try {
                // Open-Meteo API ä¸éœ€è¦é‡‘é‘°
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true&timezone=auto`;
                const res = await fetch(url);
                const wData = await res.json();
                
                if (wData.current_weather) {
                    const temp = wData.current_weather.temperature;
                    const code = wData.current_weather.weathercode;
                    
                    document.getElementById('hero-weather-temp').innerText = `${temp}Â°C`;
                    
                    // å¤©æ°£ä»£ç¢¼è½‰æ›åœ–ç¤º
                    let iconClass = 'fas fa-cloud';
                    let descText = 'å¤šé›²';
                    
                    if (code === 0) { iconClass = 'fas fa-sun'; descText = 'æ™´æœ—'; }
                    else if (code >= 1 && code <= 3) { iconClass = 'fas fa-cloud-sun'; descText = 'å¤šé›²'; }
                    else if (code >= 45 && code <= 48) { iconClass = 'fas fa-smog'; descText = 'æœ‰éœ§'; }
                    else if (code >= 51 && code <= 67) { iconClass = 'fas fa-cloud-rain'; descText = 'æœ‰é›¨'; }
                    else if (code >= 71 && code <= 77) { iconClass = 'fas fa-snowflake'; descText = 'ä¸‹é›ª'; }
                    else if (code >= 80 && code <= 82) { iconClass = 'fas fa-umbrella'; descText = 'é™£é›¨'; }
                    else if (code >= 95) { iconClass = 'fas fa-bolt'; descText = 'é›·é›¨'; }
                    
                    document.getElementById('hero-weather-icon').innerHTML = `<i class="${iconClass}"></i>`;
                    document.getElementById('hero-weather-desc').innerText = descText;
                }
            } catch (e) {
                console.error("Weather fetch failed", e);
                document.getElementById('hero-weather-desc').innerText = "ç„¡æ³•è¼‰å…¥";
            }
        }

        function createClickEffect(e) {
            if(Math.random()>0.3) return; // ä¸è¦æ¯æ¬¡é»éƒ½å‡ºç¾ï¼Œå¤ªèŠ±
            const el = document.createElement('div');
            el.innerText = ["âœˆï¸","â˜ï¸","ğŸŒ¸","ğŸ±","ğŸ˜"][Math.floor(Math.random()*5)];
            el.className = 'click-particle';
            el.style.left = e.clientX + 'px';
            el.style.top = e.clientY + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }

        function updateHero() {
            const d = data.days[currentDayIndex];
            if(d) {
                document.getElementById('hero-day-title').innerText = `Day ${currentDayIndex+1}: ${d.title}`;
                document.getElementById('hero-day-loc').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${d.location}`;
                fetchWeather(); // åˆ‡æ›æ—¥æœŸæ™‚é‡æ–°æŠ“å–è©²åœ°å¤©æ°£
            }
        }

        function switchPage(pageId, btnEl) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(btnEl) btnEl.classList.add('active');
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // Cloud Functions
        async function loadCloudData() {
            if (API_URL.includes("è«‹å¡«å…¥")) {
                console.warn("å°šæœªè¨­å®š API_URLï¼Œç•¥éé›²ç«¯åŒæ­¥");
                return;
            }
            document.getElementById('hero-day-title').innerText = "é›²ç«¯åŒæ­¥ä¸­...";
            try {
                const res = await fetch(API_URL);
                
                if (!res.ok) throw new Error("Network response was not ok");
                
                const cloudData = await res.json();
                if(cloudData && cloudData.days) {
                    data = cloudData;
                    if(!data.settings) data.settings = { showTotalsToPublic: false, defaultCurrency: 'JPY' };
                    // ä¿®å¾©æ—¥æœŸæ ¼å¼
                    data.days.forEach(d => d.date = d.date.replace(/\./g, '-'));
                    localStorage.setItem('trip_data_public', JSON.stringify(data));
                }
                console.log("è³‡æ–™åŒæ­¥æˆåŠŸï¼");
            } catch(e) {
                console.error("Sync failed", e);
                // å¢åŠ éŒ¯èª¤æç¤ºï¼Œå¹«åŠ©ä½¿ç”¨è€…ç™¼ç¾æ¬Šé™å•é¡Œ
                if(e.toString().includes('JSON')) {
                    alert("ç„¡æ³•è®€å–é›²ç«¯è³‡æ–™ï¼Œå¯èƒ½æ˜¯æ¬Šé™è¨­å®šå•é¡Œã€‚\nè«‹ç¢ºèª Google Apps Script éƒ¨ç½²è¨­å®šç‚ºã€Œä»»ä½•äºº (Anyone)ã€ã€‚");
                }
            }
            updateHero();
            renderDates();
            renderItinerary();
            renderExpenseList();
            renderTotalOverview();
        }

        function saveData() {
            localStorage.setItem('trip_data_public', JSON.stringify(data));
            if (!API_URL.includes("è«‹å¡«å…¥")) {
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = "position:fixed;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:white;padding:5px 15px;border-radius:20px;font-size:0.8rem;z-index:9999;";
                statusDiv.innerText = "â˜ï¸ å„²å­˜ä¸­...";
                document.body.appendChild(statusDiv);

                fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    // ä¿®æ­£ï¼šç§»é™¤ Content-Type æ¨™é ­ï¼Œé¿å…è·¨åŸŸå•é¡Œå°è‡´è³‡æ–™ç„¡æ³•å‚³é€
                    // headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(() => {
                    statusDiv.innerText = "âœ… é›²ç«¯å·²æ›´æ–°";
                    setTimeout(() => statusDiv.remove(), 2000);
                }).catch(e => {
                    statusDiv.innerText = "âŒ ä¸Šå‚³å¤±æ•—";
                    statusDiv.style.background = "red";
                    setTimeout(() => statusDiv.remove(), 3000);
                });
            }
        }
        function savePackData() { localStorage.setItem('my_private_data', JSON.stringify(myPacking)); }

        // === Logic: Dates & Itinerary ===
        function renderDates() {
            const container = document.getElementById('date-list');
            container.innerHTML = '';
            data.days.forEach((d, i) => {
                const dateObj = new Date(d.date);
                const dayNum = dateObj.getDate();
                const dayName = dateObj.toLocaleDateString('en-US', {weekday:'short'});
                container.innerHTML += `
                <div class="date-card ${i === currentDayIndex ? 'active' : ''}" onclick="currentDayIndex=${i}; updateHero(); renderDates(); renderItinerary();">
                    <div class="date-card-day">${dayName}</div>
                    <div class="date-card-num">${dayNum}</div>
                </div>`;
            });
            if(isAdminMode) {
                container.innerHTML += `<div class="date-card date-card-add" onclick="addNewDay()"><i class="fas fa-plus"></i></div>`;
            }
        }

        function renderItinerary() {
            const container = document.getElementById('itinerary-list');
            container.innerHTML = '';
            const day = data.days[currentDayIndex];
            if(!day || !day.events) return;
            
            day.events.sort((a,b) => a.time.localeCompare(b.time));
            
            day.events.forEach((evt, idx) => {
                const catColor = CAT_CONFIG[evt.cat] ? CAT_CONFIG[evt.cat].color : '#ccc';
                let contentHtml = `<div class="event-title-large">${evt.title}</div><div class="event-loc-row"><i class="fas fa-map-marker-alt"></i> ${evt.loc || 'æœªæŒ‡å®šåœ°é»'}</div>`;
                if (evt.note) contentHtml += `<div class="event-note-box">${evt.note}</div>`;

                container.innerHTML += `
                <div class="timeline-card-wrapper" onclick="openEventModal(${idx})">
                    <div class="timeline-time">${evt.time}</div>
                    <div class="card timeline-style" style="border-left: 5px solid ${catColor}">
                        ${contentHtml}
                        <div class="admin-only card-actions-bar">
                             <span class="action-link" onclick="event.stopPropagation(); deleteEvent(${idx})"><i class="far fa-trash-alt"></i> åˆªé™¤</span>
                        </div>
                    </div>
                </div>`;
            });
        }

        function toggleAdminMode() {
            if (isAdminMode) {
                isAdminMode = false;
                document.body.classList.remove('admin-mode');
                document.querySelectorAll('.admin-lock-btn').forEach(btn => {
                    btn.classList.remove('unlocked');
                    btn.querySelector('i').className = 'fas fa-lock';
                });
                renderDates(); 
                alert("å·²é–å®šç·¨è¼¯æ¬Šé™");
            } else {
                const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ä»¥è§£é–ç·¨è¼¯åŠŸèƒ½ï¼š");
                if (pwd === ADMIN_PASSWORD) {
                    isAdminMode = true;
                    document.body.classList.add('admin-mode');
                    document.querySelectorAll('.admin-lock-btn').forEach(btn => {
                        btn.classList.add('unlocked');
                        btn.querySelector('i').className = 'fas fa-unlock';
                    });
                    renderDates(); 
                } else if (pwd !== null) {
                    alert("å¯†ç¢¼éŒ¯èª¤");
                }
            }
        }

        // === Event Editing ===
        function openEventModal(evtIdx = null) {
            if(!isAdminMode && evtIdx === null) return; // æ²’æ¬Šé™ä¸èƒ½æ–°å¢
            
            editingEvent = { dayIdx: currentDayIndex, evtIdx: evtIdx };
            const d = data.days[currentDayIndex];
            
            if (evtIdx !== null) {
                const e = d.events[evtIdx];
                document.getElementById('evt-cat').value = e.cat;
                document.getElementById('evt-title').value = e.title;
                document.getElementById('evt-time').value = e.time;
                document.getElementById('evt-loc').value = e.loc;
                document.getElementById('evt-note').value = e.note;
                // Transport / Flight fields would be populated here in full version
            } else {
                document.getElementById('evt-cat').value = 'spot';
                document.getElementById('evt-title').value = '';
                document.getElementById('evt-time').value = '09:00';
                document.getElementById('evt-loc').value = '';
                document.getElementById('evt-note').value = '';
            }
            toggleEventFields();
            document.getElementById('modal-event').style.display = 'flex';
        }

        function toggleEventFields() {
            const cat = document.getElementById('evt-cat').value;
            document.getElementById('field-normal').style.display = (cat!=='flight'&&cat!=='transport') ? 'block':'none';
            document.getElementById('field-transport').style.display = (cat==='transport') ? 'block':'none';
            document.getElementById('field-flight').style.display = (cat==='flight') ? 'block':'none';
        }

        function saveEvent() {
            const cat = document.getElementById('evt-cat').value;
            const title = document.getElementById('evt-title').value;
            let time = document.getElementById('evt-time').value;
            let loc = document.getElementById('evt-loc').value;
            const note = document.getElementById('evt-note').value;
            
            if (!title) return alert("è«‹è¼¸å…¥è¡Œç¨‹åç¨±");
            
            const newEvt = { cat, title, time, loc, note };
            
            if (editingEvent.evtIdx !== null) {
                data.days[currentDayIndex].events[editingEvent.evtIdx] = newEvt;
            } else {
                data.days[currentDayIndex].events.push(newEvt);
            }
            saveData();
            renderItinerary();
            closeModal('modal-event');
        }

        function deleteEvent(idx) {
            if(confirm("åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) {
                data.days[currentDayIndex].events.splice(idx, 1);
                saveData();
                renderItinerary();
            }
        }

        // === List Tab Switching ===
        function switchListTab(tabName, el) {
            document.querySelectorAll('.list-tab-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            const titleEl = document.getElementById('list-page-title');
            if (tabName === 'packing') {
                titleEl.innerText = 'è¡Œææº–å‚™æ¸…å–®';
            } else if (tabName === 'shopping') {
                titleEl.innerText = 'è³¼ç‰©æ¸…å–®';
            }
        }

        // === Shopping & Packing Functions ===
        function renderShoppingList() {
            const container = document.getElementById('shopping-list-area');
            container.innerHTML = '';
            myPacking.shopping.forEach((cat, idx) => {
                const color = SHOP_COLORS[idx % SHOP_COLORS.length];
                let itemsHtml = '';
                cat.items.forEach((item, iIdx) => {
                    itemsHtml += `<div class="pack-item ${item.c?'checked':''}" onclick="togShop('${cat.name}', ${iIdx})"><input type="checkbox" ${item.c?'checked':''}><span>${item.t}</span><i class="fas fa-times" style="margin-left:auto;color:#ddd;padding:5px;" onclick="delShop('${cat.name}', ${iIdx}, event)"></i></div>`;
                });
                container.innerHTML += `
                <div class="pack-category-card shop-card" data-cat="${cat.name}" style="background-color:${color}33; border-left: 5px solid ${color};">
                    <div class="pack-title" style="color:${color}; filter: brightness(0.7); display:flex; align-items:center; gap:5px;">
                        ${cat.name} 
                        <i class="fas fa-pen" style="cursor:pointer; font-size:0.8rem; opacity:0.6;" onclick="editShopCatName(${idx})"></i>
                    </div>
                    ${itemsHtml}
                </div>`;
            });
            if(shopSortable) shopSortable.destroy();
            shopSortable = new Sortable(container, { animation: 150, delay: 200, delayOnTouchOnly: true, onEnd: function(evt) { const item = myPacking.shopping.splice(evt.oldIndex, 1)[0]; myPacking.shopping.splice(evt.newIndex, 0, item); savePackData(); renderShoppingList(); } });
        }
        
        function editShopCatName(idx) {
            const oldName = myPacking.shopping[idx].name;
            const newName = prompt("ä¿®æ”¹åˆ†é¡åç¨±:", oldName);
            if (newName && newName.trim() !== "") {
                myPacking.shopping[idx].name = newName.trim();
                savePackData();
                renderShoppingList();
            }
        }

        function openShopModal() { const select = document.getElementById('shop-add-cat'); select.innerHTML = ''; myPacking.shopping.forEach(c => { select.innerHTML += `<option value="${c.name}">${c.name}</option>`; }); select.innerHTML += `<option value="other">å…¶ä»– (æ–°å¢é …ç›®)</option>`; document.getElementById('shop-add-item').value = ''; checkShopCat(); document.getElementById('modal-shop-add').style.display = 'flex'; }
        function checkShopCat() { const val = document.getElementById('shop-add-cat').value; document.getElementById('shop-add-new-cat').style.display = (val === 'other') ? 'block' : 'none'; }
        function saveShopItem() { const select = document.getElementById('shop-add-cat'); let catName = select.value; if (catName === 'other') { catName = document.getElementById('shop-add-new-cat').value.trim(); if (!catName) return alert("è«‹è¼¸å…¥åˆ†é¡åç¨±"); } const itemName = document.getElementById('shop-add-item').value.trim(); if (!itemName) return alert("è«‹è¼¸å…¥ç‰©å“åç¨±"); let cat = myPacking.shopping.find(c => c.name === catName); if (!cat) { cat = { name: catName, items: [] }; myPacking.shopping.push(cat); } cat.items.push({ t: itemName, c: false }); savePackData(); renderShoppingList(); closeModal('modal-shop-add'); }
        function togShop(catName, idx) { const cat = myPacking.shopping.find(c => c.name === catName); if(cat) { cat.items[idx].c = !cat.items[idx].c; savePackData(); renderShoppingList(); } }
        function delShop(catName, idx, e) { e.stopPropagation(); if(confirm('åˆªé™¤è³¼ç‰©é …ç›®ï¼Ÿ')) { const cat = myPacking.shopping.find(c => c.name === catName); if(cat) { cat.items.splice(idx, 1); savePackData(); renderShoppingList(); } } }

        function renderPackingList() {
            const d=document.getElementById('packing-sections'); d.innerHTML='';
            Object.keys(PACK_UI).forEach(k => {
                const conf = PACK_UI[k]; const items = myPacking[k] || [];
                let h = '';
                items.forEach((it, i) => { h += `<div class="pack-item ${it.c?'checked':''}" onclick="togPack('${k}',${i})"><input type="checkbox" ${it.c?'checked':''}><span>${it.t}</span><i class="fas fa-times" style="margin-left:auto;color:#ddd;padding:5px;" onclick="delPack('${k}',${i},event)"></i></div>`; });
                d.innerHTML += `<div class="pack-category-card" style="background-color:${conf.bg}"><div class="pack-title">${conf.name}</div>${h}</div>`;
            });
        }
        function togPack(k,i){ myPacking[k][i].c=!myPacking[k][i].c; savePackData(); renderPackingList(); }
        function delPack(k,i,e){ e.stopPropagation(); if(confirm('åˆªé™¤?')){ myPacking[k].splice(i,1); savePackData(); renderPackingList(); } }
        function openPackModal(){ document.getElementById('modal-pack-add').style.display='flex'; }
        function saveNewPackItem(){ const n=document.getElementById('pack-add-name').value; if(n){ myPacking[document.getElementById('pack-add-cat').value].push({t:n,c:false}); savePackData(); renderPackingList(); closeModal('modal-pack-add'); document.getElementById('pack-add-name').value=''; }}

        // === Day Editing ===
        function openDayEditModal() { if(!isAdminMode) return; const d = data.days[currentDayIndex]; document.getElementById('day-edit-title').value = d.title; document.getElementById('day-edit-loc').value = d.location; document.getElementById('day-edit-date').value = d.date; document.getElementById('modal-day-edit').style.display = 'flex'; }
        function saveDayInfo() { const title = document.getElementById('day-edit-title').value; const loc = document.getElementById('day-edit-loc').value; const newDateStr = document.getElementById('day-edit-date').value; if (title) data.days[currentDayIndex].title = title; if (loc) data.days[currentDayIndex].location = loc; if (newDateStr && newDateStr !== data.days[currentDayIndex].date) { if (currentDayIndex === 0) { const oldStart = new Date(data.days[0].date); const newStart = new Date(newDateStr); const diffTime = newStart - oldStart; data.days.forEach(d => { const current = new Date(d.date); const newD = new Date(current.getTime() + diffTime); d.date = newD.toISOString().split('T')[0]; }); } else { data.days[currentDayIndex].date = newDateStr; } } saveData(); updateHero(); renderDates(); closeModal('modal-day-edit'); }
        function addNewDay() { if(!isAdminMode) return; const lastDay = data.days[data.days.length - 1]; const nextDate = new Date(lastDay.date); nextDate.setDate(nextDate.getDate() + 1); data.days.push({ date: nextDate.toISOString().split('T')[0], title: "è‡ªç”±æ´»å‹•", location: "Osaka", events: [] }); saveData(); renderDates(); currentDayIndex = data.days.length - 1; updateHero(); renderItinerary(); }
        function deleteDay() { if(confirm("ç¢ºå®šåˆªé™¤é€™æ•´å¤©çš„è¡Œç¨‹å—ï¼Ÿ")) { data.days.splice(currentDayIndex, 1); if(data.days.length === 0) { data.days.push({date: "2026-01-01", title: "New Trip", location: "Japan", events: []}); } currentDayIndex = 0; saveData(); closeModal('modal-day-edit'); renderDates(); updateHero(); renderItinerary(); } }

        // === Expense & Rates ===
        async function fetchExchangeRate() { 
            try { 
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/TWD'); 
                const d = await res.json(); 
                if(d.rates) { 
                    if(d.rates.JPY) rates.JPY = 1 / d.rates.JPY;
                    if(d.rates.KRW) rates.KRW = 1 / d.rates.KRW;
                    rates.TWD = 1;
                } 
            } catch(e) { 
                console.log("Rate fetch failed, using defaults"); 
            } 
            document.getElementById('settlement-rate-info').innerText = 
                `åŒ¯ç‡: 1 JPYâ‰ˆ${rates.JPY.toFixed(3)} | 1 KRWâ‰ˆ${rates.KRW.toFixed(3)} TWD`;
        }

        function updateCurrencyUI() {
            const cur = document.getElementById('exp-currency').value;
            document.querySelectorAll('.currency-label').forEach(el => el.innerText = cur);
        }

        function openExpenseModal(editId=null) {
            editingExpenseId = editId;
            const defaultCurr = (data.settings && data.settings.defaultCurrency) ? data.settings.defaultCurrency : 'JPY';
            
            let editData = null;
            if (editId) { 
                editData = data.expenses.find(e => e.id === editId); 
                if(editData.type === 'transfer') return; 
                document.getElementById('exp-modal-title').innerText = "ä¿®æ”¹å¸³ç›®"; 
            } else { 
                document.getElementById('exp-modal-title').innerText = "è¨˜ä¸€ç­†"; 
            }

            if (editData) {
                document.getElementById('exp-date').value = editData.date;
                document.getElementById('exp-currency').value = editData.currency;
                document.getElementById('exp-title').value = editData.title;
                document.getElementById('exp-amount').value = editData.amount;
                document.getElementById('exp-note').value = editData.note || '';
            } else {
                document.getElementById('exp-date').value = new Date().toISOString().split('T')[0]; 
                document.getElementById('exp-currency').value = defaultCurr; 
                document.getElementById('exp-title').value = ''; 
                document.getElementById('exp-amount').value = ''; 
                document.getElementById('exp-note').value = '';
            }
            updateCurrencyUI();

            // A. Payer List
            const payerCont = document.getElementById('payer-list-container'); 
            payerCont.innerHTML = '';
            data.members.forEach(m => {
                let val = 0;
                if (editData) {
                    if (typeof editData.payer === 'string') {
                        if(editData.payer === m) val = editData.amount;
                    } else if (editData.payers && editData.payers[m]) {
                        val = editData.payers[m];
                    }
                } else if (m === data.members[0]) { 
                    val = 0; 
                }
                
                payerCont.innerHTML += `
                <div class="payer-row">
                    <span class="payer-name">${m}</span>
                    <input type="number" class="payer-amt" data-m="${m}" value="${val === 0 ? '' : val}" placeholder="0" oninput="checkPayerTotal()">
                </div>`;
            });

            // B. Split List
            const splitCont = document.getElementById('split-list-container'); 
            splitCont.innerHTML = '';
            
            data.members.forEach(m => {
                let isChecked = true; 
                let splitAmount = 0;
                let isLocked = false; 

                if (editData && editData.splitDetails) {
                    if (editData.splitDetails[m] !== undefined && editData.splitDetails[m] > 0) { 
                        isChecked = true; 
                        splitAmount = editData.splitDetails[m];
                        isLocked = true; 
                    } else { 
                        isChecked = false; 
                    }
                }
                
                splitCont.innerHTML += `
                <div class="split-row-compact">
                    <input type="checkbox" class="split-cb" value="${m}" ${isChecked ? 'checked' : ''} onchange="recalcSmartSplit()">
                    <span class="split-name">${m}</span>
                    <input type="number" class="split-amt ${isLocked?'manual-calc':'auto-calc'}" 
                        data-m="${m}" data-locked="${isLocked}" value="${splitAmount}" 
                        onfocus="if(this.classList.contains('auto-calc')) this.select();" 
                        oninput="handleManualSplitInput(this)">
                </div>`;
            }); 

            if (editData) setSplitMode('custom'); 
            else setSplitMode('avg'); 
            
            document.getElementById('modal-expense').style.display = 'flex'; 
        }

        function distributePayerAmount() {
            const total = parseFloat(document.getElementById('exp-amount').value) || 0;
            const payers = document.querySelectorAll('.payer-amt');
            let currentSum = 0;
            payers.forEach(p => currentSum += (parseFloat(p.value) || 0));
            
            if (currentSum === 0 || (payers[0].value > 0 && currentSum == parseFloat(payers[0].value))) {
                payers.forEach(p => p.value = ''); 
                payers[0].value = total; 
            }
            checkPayerTotal();
            if (splitMode === 'avg') calculateSplitPreview();
            else recalcSmartSplit();
        }

        function checkPayerTotal() {
            const total = parseFloat(document.getElementById('exp-amount').value) || 0;
            let pSum = 0;
            document.querySelectorAll('.payer-amt').forEach(p => pSum += (parseFloat(p.value) || 0));
            
            const el = document.getElementById('payer-total-check');
            const diff = total - pSum;
            if (Math.abs(diff) < 0.1) {
                el.innerText = "âœ… é‡‘é¡å»åˆ";
                el.style.color = "green";
            } else {
                el.innerText = `âŒ å·®é¡ ${diff.toFixed(1)}`;
                el.style.color = "red";
            }
        }
        function chkTotal(){
             const total = parseFloat(document.getElementById('exp-amount').value) || 0;
             let sSum = 0;
             document.querySelectorAll('.split-amt').forEach(i => sSum += (parseFloat(i.value)||0));
             const el = document.getElementById('split-total-check');
             const r = total - sSum;
             el.innerText = `å·®é¡: ${r.toFixed(0)}`;
        }

        function handleManualSplitInput(el) {
            el.dataset.locked = "true";
            el.classList.remove('auto-calc');
            el.classList.add('manual-calc');
            recalcSmartSplit();
        }

        function recalcSmartSplit() {
            if (splitMode === 'avg') return calculateSplitPreview();
            
            const total = parseFloat(document.getElementById('exp-amount').value) || 0;
            const cbs = document.querySelectorAll('.split-cb');
            const inps = document.querySelectorAll('.split-amt');
            
            let manualSum = 0;
            let autoCandidates = [];

            inps.forEach((inp, idx) => {
                const isChecked = cbs[idx].checked;
                
                if (!isChecked) {
                    inp.value = 0;
                    inp.dataset.locked = "false"; 
                    inp.classList.add('auto-calc');
                    inp.classList.remove('manual-calc');
                    inp.disabled = true; 
                } else {
                    inp.disabled = false;
                    if (inp.dataset.locked === "true") {
                        manualSum += (parseFloat(inp.value) || 0);
                    } else {
                        autoCandidates.push(inp);
                    }
                }
            });

            const remaining = total - manualSum;
            const count = autoCandidates.length;

            if (count > 0) {
                let baseAvg = Math.floor(remaining / count);
                let remainder = remaining % count; 

                autoCandidates.forEach(inp => {
                    let val = baseAvg;
                    if (remainder > 0) { val += 1; remainder--; }
                    else if (remainder < 0) { val -= 1; remainder++; }

                    inp.value = val;
                    inp.classList.add('auto-calc');
                    inp.classList.remove('manual-calc');
                });
            }
            chkTotal();
        }

        function calculateSplitPreview(){ if(splitMode!=='avg') return; const t=parseFloat(document.getElementById('exp-amount').value)||0; const cbs=document.querySelectorAll('.split-cb'); const inps=document.querySelectorAll('.split-amt'); let cnt=0; cbs.forEach(c=>{if(c.checked)cnt++}); const avg=cnt>0?Math.floor(t/cnt):0; let rem=cnt>0?t-(avg*cnt):0; inps.forEach((inp,i)=>{ if(cbs[i].checked){ let v=avg; if(rem>0){v++;rem--;} inp.value=v; } else inp.value=0; }); chkTotal(); }
        
        function setSplitMode(m) {
            splitMode = m;
            document.getElementById('mode-avg').classList.toggle('active', m === 'avg');
            document.getElementById('mode-custom').classList.toggle('active', m === 'custom');
            
            const inps = document.querySelectorAll('.split-amt');
            const cbs = document.querySelectorAll('.split-cb');
            
            if (m === 'avg') {
                 inps.forEach(i => i.disabled = true);
                 calculateSplitPreview();
            } else {
                inps.forEach((i, idx) => {
                    i.disabled = !cbs[idx].checked;
                    i.dataset.locked = "false"; 
                    i.classList.add('auto-calc');
                    i.classList.remove('manual-calc');
                });
                recalcSmartSplit();
            }
        }

        function saveExpense() { 
            const t = document.getElementById('exp-title').value; 
            const a = parseFloat(document.getElementById('exp-amount').value); 
            if(!t || isNaN(a) || a <= 0) return alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é …ç›®èˆ‡é‡‘é¡'); 
            
            let payersObj = {};
            let payerSum = 0;
            document.querySelectorAll('.payer-amt').forEach(p => {
                const val = parseFloat(p.value) || 0;
                if (val > 0) {
                    payersObj[p.dataset.m] = val;
                    payerSum += val;
                }
            });
            
            if (Math.abs(payerSum - a) > 1) return alert(`ä»˜æ¬¾é‡‘é¡ç¸½å’Œ (${payerSum}) èˆ‡ç¸½é‡‘é¡ (${a}) ä¸ç¬¦`);

            let sd = {}; let s = 0; 
            document.querySelectorAll('.split-amt').forEach(i => { 
                const v = parseFloat(i.value) || 0; 
                if(v > 0) { sd[i.dataset.m] = v; s += v; } 
            }); 
            
            if(Math.abs(s - a) > 5) return alert('åˆ†å¸³é‡‘é¡ç¸½å’Œä¸ç¬¦ï¼Œè«‹æª¢æŸ¥åˆ†é…ã€‚'); 
            
            const mainPayer = Object.keys(payersObj).length === 1 ? Object.keys(payersObj)[0] : "å¤šä½ä»˜æ¬¾";

            const expenseObj = { 
                id: editingExpenseId || Date.now().toString(), 
                date: document.getElementById('exp-date').value, 
                currency: document.getElementById('exp-currency').value, 
                title: t, 
                amount: a, 
                payer: mainPayer, 
                payers: payersObj, 
                splitDetails: sd, 
                note: document.getElementById('exp-note').value, 
                type: 'normal' 
            };

            if (editingExpenseId) { 
                const idx = data.expenses.findIndex(e => e.id === editingExpenseId); 
                if (idx !== -1) data.expenses[idx] = expenseObj; 
            } else { 
                data.expenses.push(expenseObj); 
            } 
            saveData(); 
            renderExpenseList(); 
            renderTotalOverview(); 
            closeModal('modal-expense'); 
        }

        function saveDefaultCurrency() {
            if (!data.settings) data.settings = {};
            data.settings.defaultCurrency = document.getElementById('default-currency-select').value;
            saveData();
        }

        function togglePublicView() {
            data.settings.showTotalsToPublic = document.getElementById('public-view-toggle').checked;
            saveData();
            renderSettlement();
        }

        function renderSettlement() { 
            let spending = {}; data.members.forEach(m => spending[m] = 0);
            let Balances = { TWD: {}, JPY: {}, KRW: {} };
            const currencies = ['TWD', 'JPY', 'KRW'];
            
            currencies.forEach(c => {
                Balances[c] = {};
                data.members.forEach(m => Balances[c][m] = 0);
            });
            
            data.expenses.forEach(e => { 
                const cur = e.currency || 'JPY';
                if (!Balances[cur]) return;

                if (e.payers) {
                    for (let pName in e.payers) {
                        Balances[cur][pName] += e.payers[pName];
                    }
                } else if (e.payer && typeof e.payer === 'string') {
                    Balances[cur][e.payer] += e.amount;
                }
                
                Object.keys(e.splitDetails).forEach(k => {
                    Balances[cur][k] -= e.splitDetails[k];
                    
                    if (e.type !== 'transfer') {
                        let amountTWD = e.splitDetails[k];
                        if (cur !== 'TWD') {
                            amountTWD = amountTWD * rates[cur]; 
                        }
                        spending[k] += amountTWD;
                    }
                }); 
            }); 
            
            const showDetails = isAdminMode || (data.settings && data.settings.showTotalsToPublic);
            if (data.settings && data.settings.defaultCurrency) {
                 document.getElementById('default-currency-select').value = data.settings.defaultCurrency;
            }

            let summaryHtml = `<div class="settlement-summary ${showDetails ? 'visible' : ''}"><h4>ğŸ’° å€‹äººç¸½æ¶ˆè²» (ç´„åˆå°å¹£)</h4>`;
            for (const [m, amt] of Object.entries(spending)) { 
                summaryHtml += `<div class="summary-row"><span>${m}</span><span>NT$ ${Math.round(amt).toLocaleString()}</span></div>`; 
            }
            summaryHtml += '</div>';
            
            function calculateDebts(balanceMap, unitName) { 
                let d = [], c = []; 
                for (let m in balanceMap) {
                    if (balanceMap[m] < -1) d.push({ p: m, v: balanceMap[m] }); 
                    else if (balanceMap[m] > 1) c.push({ p: m, v: balanceMap[m] });
                } 
                let h = `<h4>${unitName} å»ºè­°è½‰å¸³</h4>`; 
                if (d.length === 0 && c.length === 0) return ''; 
                if (d.length === 0) return h + '<div style="color:#ccc; margin-bottom:15px;">å·²çµæ¸…</div>'; 
                
                while (d.length > 0 && c.length > 0) { 
                    d.sort((a, b) => a.v - b.v); c.sort((a, b) => b.v - a.v); 
                    let amount = Math.min(Math.abs(d[0].v), c[0].v); 
                    
                    h += `<div class="transfer-row">
                            <span>${d[0].p}</span><i class="fas fa-arrow-right"></i><span>${c[0].p}</span>
                            <span class="money">${Math.round(amount).toLocaleString()}</span>
                          </div>`; 
                    
                    d[0].v += amount; c[0].v -= amount; 
                    if (Math.abs(d[0].v) < 1) d.shift(); 
                    if (c[0].v < 1) c.shift(); 
                } 
                return h; 
            } 
            
            document.getElementById('settlement-content').innerHTML = 
                summaryHtml + 
                calculateDebts(Balances.KRW, 'ğŸ‡°ğŸ‡· éŸ“å…ƒ') + 
                calculateDebts(Balances.JPY, 'ğŸ‡¯ğŸ‡µ æ—¥å¹£') + 
                calculateDebts(Balances.TWD, 'ğŸ‡¹ğŸ‡¼ å°å¹£'); 
            
            document.getElementById('modal-settlement').style.display = 'flex'; 
        }

        // === Transfers & List ===
        function openTransferModal(editId=null) {
            if(!isAdminMode) return;
            editingTransferId = editId;

            const fromS = document.getElementById('trans-from');
            const toS = document.getElementById('trans-to');
            fromS.innerHTML = ''; toS.innerHTML = '';
            data.members.forEach(m => {
                fromS.innerHTML += `<option value="${m}">${m}</option>`;
                toS.innerHTML += `<option value="${m}">${m}</option>`;
            });

            if (editId) {
                const trans = data.expenses.find(e => e.id === editId);
                document.getElementById('trans-modal-title').innerText = "ä¿®æ”¹è½‰å¸³";
                document.getElementById('trans-date').value = trans.date;
                document.getElementById('trans-currency').value = trans.currency;
                document.getElementById('trans-from').value = trans.payer;
                document.getElementById('trans-to').value = Object.keys(trans.splitDetails)[0];
                document.getElementById('trans-amount').value = trans.amount;
            } else {
                document.getElementById('trans-modal-title').innerText = "æ–°å¢è½‰å¸³ (é‚„æ¬¾)";
                document.getElementById('trans-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('trans-amount').value = '';
            }
            
            closeModal('modal-settlement'); 
            document.getElementById('modal-transfer').style.display = 'flex';
        }

        function saveTransfer() {
            const date = document.getElementById('trans-date').value;
            const cur = document.getElementById('trans-currency').value;
            const from = document.getElementById('trans-from').value;
            const to = document.getElementById('trans-to').value;
            const amt = parseFloat(document.getElementById('trans-amount').value);

            if (from === to) return alert("è½‰å‡ºèˆ‡è½‰å…¥äººä¸èƒ½ç›¸åŒ");
            if (!amt || amt <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡");

            const expenseObj = {
                id: editingTransferId || Date.now().toString(),
                date: date,
                currency: cur,
                title: "è½‰å¸³ (é‚„æ¬¾)",
                amount: amt,
                payer: from,
                splitDetails: { [to]: amt }, 
                note: "Transfer Record",
                type: 'transfer'
            };
            
            if (editingTransferId) {
                const idx = data.expenses.findIndex(e => e.id === editingTransferId);
                if(idx !== -1) data.expenses[idx] = expenseObj;
            } else {
                data.expenses.push(expenseObj);
            }
            
            saveData();
            renderExpenseList();
            renderTotalOverview();
            closeModal('modal-transfer');
            renderSettlement(); 
        }

        function deleteExpense(id) { 
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')) { 
                data.expenses = data.expenses.filter(e => e.id !== id); 
                saveData(); 
                renderExpenseList(); 
                renderTotalOverview(); 
            } 
        }

        function renderExpenseList() {
            const l = document.getElementById('expense-list'); l.innerHTML = '';
            const sorted = data.expenses.slice().sort((a, b) => {
                if (a.date !== b.date) return new Date(a.date) - new Date(b.date);
                return a.id - b.id;
            });
            sorted.forEach((e) => {
                let payerText = e.payer;
                if (e.payers && Object.keys(e.payers).length > 1) {
                    payerText = "å¤šäººå…ˆä»˜";
                }

                let html = '';
                if (e.type === 'transfer') {
                    const toMember = Object.keys(e.splitDetails)[0];
                    html = `
                    <div class="expense-card transfer-type" data-id="${e.id}">
                        <div class="expense-info-left" style="display:flex; align-items:center; gap:10px;">
                            <div style="font-size:1.2rem; color:#2196F3;"><i class="fas fa-exchange-alt"></i></div>
                            <div>
                                <div style="font-size:0.8rem;color:#666">${e.date}</div>
                                <div style="font-weight:bold; font-size:1rem; color:#0D47A1;">${e.payer} <i class="fas fa-arrow-right" style="font-size:0.8rem"></i> ${toMember}</div>
                            </div>
                        </div>
                        <div style="text-align:right">
                            <div class="money" style="font-size:1.2rem; color:#2196F3">${e.currency} ${e.amount.toLocaleString()}</div>
                            <div class="admin-only" style="margin-top:5px; gap:10px; justify-content:flex-end;">
                                 <i class="far fa-edit" style="color:#aaa; cursor:pointer;" onclick="openTransferModal('${e.id}')"></i>
                                 <i class="far fa-trash-alt" style="color:#ffcccb; cursor:pointer;" onclick="deleteExpense('${e.id}')"></i>
                            </div>
                        </div>
                    </div>`;
                } else {
                    html = `
                    <div class="expense-card" data-id="${e.id}">
                        <div class="expense-info-left">
                            <div style="font-size:0.8rem;color:#888">${e.date}</div>
                            <div style="font-weight:bold; font-size:1.1rem; font-family:var(--font-serif);">${e.title}</div>
                            <div style="font-size:0.8rem; color:#666;">${payerText}</div>
                        </div>
                        <div style="text-align:right">
                            <div class="money" style="font-size:1.2rem; color:var(--theme-brown)">${e.currency} ${e.amount.toLocaleString()}</div>
                            <div class="admin-only" style="margin-top:5px; gap:10px; justify-content:flex-end;">
                                 <i class="far fa-edit" style="color:#aaa; cursor:pointer;" onclick="openExpenseModal('${e.id}')"></i>
                                 <i class="far fa-trash-alt" style="color:#ffcccb; cursor:pointer;" onclick="deleteExpense('${e.id}')"></i>
                            </div>
                        </div>
                    </div>`;
                }
                l.innerHTML += html;
            });
            if (expSortable) expSortable.destroy();
            expSortable = new Sortable(l, { animation: 150, delay: 200, delayOnTouchOnly: true, ghostClass: 'sortable-ghost' });
        }

        function renderTotalOverview(){ 
            let totalTWD = 0; 
            data.expenses.forEach(e=>{
                if(e.type !== 'transfer') {
                    let r = rates[e.currency] || 1; 
                    totalTWD += e.amount * r;
                }
            }); 
            document.getElementById('total-expense-display').innerHTML=`ç¸½æ”¯å‡º: NT$ ${Math.round(totalTWD).toLocaleString()}`; 
        }
        
        function openMembersModal(){const d=document.getElementById('members-list-edit');d.innerHTML='';data.members.forEach(m=>d.innerHTML+=`<div style="display:flex;margin-bottom:5px"><input value="${m}" style="margin:0"><button class="btn-icon" onclick="this.parentElement.remove()">X</button></div>`);document.getElementById('modal-members').style.display='flex';}
        function addNewMemberField(){document.getElementById('members-list-edit').innerHTML+=`<div style="display:flex;margin-bottom:5px"><input placeholder="æ–°æˆå“¡" style="margin:0"><button class="btn-icon" onclick="this.parentElement.remove()">X</button></div>`;}
        function saveMembers(){const a=[];document.querySelectorAll('#members-list-edit input').forEach(i=>{if(i.value)a.push(i.value)});if(a.length>0){data.members=a;saveData();closeModal('modal-members');renderExpenseList();}}
    </script>
</body>
</html>
